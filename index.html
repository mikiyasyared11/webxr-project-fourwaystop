<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>4-Way Stop â€¢ Realistic Details</title>
  <meta name="description" content="Realistic WebXR Traffic Simulation for Urban Planning">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <script>
    /* ======================================================================
       SYSTEM: TRAFFIC ARBITER
       "Vehicles slow down, line up correctly, and take turns" 
       ====================================================================== */
    AFRAME.registerSystem('traffic-arbiter', {
      init() {
        this.queue = [];
        this.activeCar = null;
        this.lastClearTime = 0;
        this.minGap = 2000; // 2 seconds between turns for safety
        this.stuckTimer = 0;
      },

      registerArrival(carEl) {
        if (!this.queue.includes(carEl)) {
          this.queue.push(carEl);
        }
      },

      notifyClear(carEl) {
        if (this.activeCar === carEl) {
          this.activeCar = null;
          this.lastClearTime = Date.now();
        }
      },

      tick(t, dt) {
        const now = Date.now();

        // Safety: Clear stuck cars if they take >8 seconds to turn
        if (this.activeCar) {
            this.stuckTimer += dt;
            if (this.stuckTimer > 8000) {
                this.activeCar = null; 
                this.stuckTimer = 0;
            }
        } else {
            this.stuckTimer = 0;
        }

        // FIFO Green Light Logic
        if (!this.activeCar && this.queue.length > 0 && (now - this.lastClearTime > this.minGap)) {
            const nextCar = this.queue.shift();
            if (nextCar && nextCar.parentNode) {
                this.activeCar = nextCar;
                nextCar.emit('proceed-signal');
            }
        }
      }
    });

    /* ======================================================================
       SYSTEM: TRAFFIC GENERATOR
       ====================================================================== */
    AFRAME.registerSystem('traffic-generator', {
      init() {
        this.timer = 0;
        this.interval = 3500; 
        this.lanes = [
            { axis: 'z', dir: -1, color: '#c0392b' }, // North
            { axis: 'z', dir: 1,  color: '#2980b9' },  // South
            { axis: 'x', dir: 1,  color: '#f39c12' },  // East
            { axis: 'x', dir: -1, color: '#8e44ad' }   // West
        ];
        this.laneIdx = 0;
      },
      tick(t, dt) {
        this.timer += dt;
        if (this.timer > this.interval) {
            this.spawn();
            this.timer = 0;
            this.interval = 3000 + Math.random() * 2500;
        }
      },
      spawn() {
        const cfg = this.lanes[this.laneIdx];
        const car = document.createElement('a-entity');
        car.setAttribute('car-controller', {axis: cfg.axis, dir: cfg.dir, color: cfg.color});
        this.el.appendChild(car);
        this.laneIdx = (this.laneIdx + 1) % 4;
      }
    });

    /* ======================================================================
       COMPONENT: CAR CONTROLLER
       Handles Physics, AI, Visuals
       ====================================================================== */
    AFRAME.registerComponent('car-controller', {
      schema: {
        axis: { default: 'z' },
        dir: { type: 'number' },
        color: { type: 'color', default: 'red' },
        speed: { default: 6 }
      },

      init() {
        this.laneOffset = 2.0; 
        // Stop line is at 6.5m. Car center needs to be further back 
        // so the front bumper (approx 1.8m from center) hits the line.
        this.stopTarget = 6.5 + 1.8; 
        
        this.state = 'driving'; 
        this.intention = this.pickIntention();
        this.turnProgress = 0;

        this.buildCar();
        this.resetPosition();

        this.el.addEventListener('proceed-signal', () => {
            // Signal before moving
            this.toggleTurnSignal(true);
            setTimeout(() => { this.state = 'crossing'; }, 500);
        });
      },

      pickIntention() {
        const r = Math.random();
        if (r < 0.45) return 'straight';
        if (r < 0.75) return 'right';
        return 'left';
      },

      buildCar() {
        // --- REALISTIC CAR MODEL ---
        // 1. Main Body
        const body = document.createElement('a-box');
        body.setAttribute('scale', '1.7 0.6 3.8');
        body.setAttribute('position', '0 0.5 0');
        body.setAttribute('color', this.data.color);
        body.setAttribute('shadow', 'cast:true');
        this.el.appendChild(body);
        
        // 2. Cabin/Top
        const cabin = document.createElement('a-box');
        cabin.setAttribute('scale', '1.5 0.55 2.0');
        cabin.setAttribute('position', '0 1.1 0.2'); // Set back slightly
        cabin.setAttribute('color', this.data.color); 
        this.el.appendChild(cabin);

        // 3. Windows (Black Glass)
        const windshield = document.createElement('a-plane');
        windshield.setAttribute('color', '#111');
        windshield.setAttribute('scale', '1.4 0.5 1');
        windshield.setAttribute('position', '0 1.1 -0.81'); // Front
        windshield.setAttribute('rotation', '0 180 0');
        this.el.appendChild(windshield);

        const rearWindow = document.createElement('a-plane');
        rearWindow.setAttribute('color', '#111');
        rearWindow.setAttribute('scale', '1.4 0.5 1');
        rearWindow.setAttribute('position', '0 1.1 1.21'); // Rear
        this.el.appendChild(rearWindow);

        // 4. Bumpers
        const fBump = document.createElement('a-box');
        fBump.setAttribute('color', '#555');
        fBump.setAttribute('scale', '1.75 0.2 0.2');
        fBump.setAttribute('position', '0 0.4 -1.95');
        this.el.appendChild(fBump);
        
        const bBump = fBump.cloneNode();
        bBump.setAttribute('position', '0 0.4 1.95');
        this.el.appendChild(bBump);

        // 5. Headlights
        const hlL = document.createElement('a-sphere');
        hlL.setAttribute('radius', 0.12);
        hlL.setAttribute('position', '-0.6 0.6 -1.92');
        hlL.setAttribute('color', '#fff9c4');
        hlL.setAttribute('material', 'emissive: #fff9c4; emissiveIntensity: 0.8');
        this.el.appendChild(hlL);
        const hlR = hlL.cloneNode();
        hlR.setAttribute('position', '0.6 0.6 -1.92');
        this.el.appendChild(hlR);

        // 6. Wheels
        const w1 = this.makeWheel(0.9, 0.35, 1.1);
        const w2 = this.makeWheel(-0.9, 0.35, 1.1);
        const w3 = this.makeWheel(0.9, 0.35, -1.1);
        const w4 = this.makeWheel(-0.9, 0.35, -1.1);
        this.el.appendChild(w1); this.el.appendChild(w2);
        this.el.appendChild(w3); this.el.appendChild(w4);

        // 7. Turn Signals (Hidden by default)
        this.turnL = document.createElement('a-sphere');
        this.turnL.setAttribute('radius', 0.08);
        this.turnL.setAttribute('color', '#ff9900');
        this.turnL.setAttribute('position', '-0.8 0.6 -1.92');
        this.turnL.setAttribute('visible', false);
        this.el.appendChild(this.turnL);

        this.turnR = this.turnL.cloneNode();
        this.turnR.setAttribute('position', '0.8 0.6 -1.92');
        this.turnR.setAttribute('visible', false);
        this.el.appendChild(this.turnR);
      },

      makeWheel(x,y,z) {
        const w = document.createElement('a-cylinder');
        w.setAttribute('rotation', '0 0 90');
        w.setAttribute('radius', 0.35);
        w.setAttribute('height', 0.25);
        w.setAttribute('color', '#222');
        w.setAttribute('position', `${x} ${y} ${z}`);
        return w;
      },

      toggleTurnSignal(on) {
        if (!on) {
            this.turnL.setAttribute('visible', false);
            this.turnR.setAttribute('visible', false);
            return;
        }
        if (this.intention === 'left') this.turnL.setAttribute('visible', true);
        if (this.intention === 'right') this.turnR.setAttribute('visible', true);
      },

      resetPosition() {
        const startDist = 75;
        // Right Hand Drive Logic
        if (this.data.axis === 'z') {
           const xPos = (this.data.dir === -1) ? this.laneOffset : -this.laneOffset;
           this.el.object3D.position.set(xPos, 0, startDist * -this.data.dir);
           this.el.object3D.rotation.y = (this.data.dir === 1) ? 0 : Math.PI;
        } else {
           const zPos = (this.data.dir === 1) ? this.laneOffset : -this.laneOffset;
           this.el.object3D.position.set(startDist * -this.data.dir, 0, zPos);
           this.el.object3D.rotation.y = (this.data.dir === 1) ? -Math.PI/2 : Math.PI/2;
        }
      },

      scanTraffic() {
        // Sensor: Detect car ahead to prevent rear-ending
        const myPos = (this.data.axis === 'z') ? this.el.object3D.position.z : this.el.object3D.position.x;
        const all = document.querySelectorAll('[car-controller]');
        let dist = 1000;

        for (let i = 0; i < all.length; i++) {
            if (all[i] === this.el) continue;
            const other = all[i].components['car-controller'];
            if (!other) continue;

            // Strict Lane Check
            if (other.data.axis === this.data.axis && other.data.dir === this.data.dir) {
                // Ignore cars that have left the queue (Crossing/Departing)
                if (other.state !== 'driving' && other.state !== 'queued') continue;

                const otherPos = (this.data.axis === 'z') ? all[i].object3D.position.z : all[i].object3D.position.x;
                const d = (otherPos - myPos) * this.data.dir; // Positive = Ahead
                if (d > 0 && d < dist) dist = d;
            }
        }
        return dist;
      },

      tick(t, dt) {
        const delta = dt / 1000;
        const p = this.el.object3D.position;

        // --- DRIVING STATE ---
        if (this.state === 'driving' || this.state === 'queued') {
            const distAhead = this.scanTraffic();
            
            // 1. Maintain Gap (Queueing)
            if (distAhead < 9) { // 9m gap
                this.state = 'queued';
                return; // Brake
            } else {
                this.state = 'driving';
            }

            // 2. Stop Line Check
            const curr = (this.data.axis === 'z') ? p.z : p.x;
            // Stop if center of car reaches stopTarget (which ensures bumper is at line)
            if (Math.abs(curr) <= this.stopTarget) {
                // Hard snap to exact stop position
                if (this.data.axis === 'z') p.z = this.stopTarget * -this.data.dir;
                else p.x = this.stopTarget * -this.data.dir;
                
                this.state = 'waiting';
                this.el.sceneEl.systems['traffic-arbiter'].registerArrival(this.el);
                return;
            }

            // Move
            const move = this.data.dir * this.data.speed * delta;
            if (this.data.axis === 'z') p.z += move; else p.x += move;
        }

        // --- CROSSING STATE ---
        else if (this.state === 'crossing') {
            const speed = 7.5; 
            
            if (this.intention === 'straight') {
                this.el.object3D.translateZ(speed * delta);
            } else {
                // Arc Turn
                const turnSpeed = (Math.PI/2) * delta * 0.8;
                this.turnProgress += turnSpeed;
                this.el.object3D.translateZ(speed * delta);
                
                if (this.intention === 'right') this.el.object3D.rotateY(-turnSpeed);
                else this.el.object3D.rotateY(turnSpeed * 0.75);

                if (this.turnProgress >= Math.PI/2) {
                    // Lock rotation to 90 degrees
                    const y = this.el.object3D.rotation.y;
                    this.el.object3D.rotation.y = Math.round(y / (Math.PI/2)) * (Math.PI/2);
                    this.state = 'departing';
                    this.toggleTurnSignal(false);
                }
            }

            // Clearance check (> 12m from center)
            const distSq = p.x*p.x + p.z*p.z;
            if (distSq > 144) { 
                this.el.sceneEl.systems['traffic-arbiter'].notifyClear(this.el);
                if (this.intention === 'straight') this.state = 'departing';
            }
        }

        // --- DEPARTING STATE ---
        else if (this.state === 'departing') {
            this.el.object3D.translateZ(this.data.speed * delta);
            if (Math.abs(p.x) > 90 || Math.abs(p.z) > 90) {
                this.el.remove();
            }
        }
      }
    });

    /* ======================================================================
       COMPONENT: ENVIRONMENT (Sidewalks, Trees, Lights)
       ====================================================================== */
    AFRAME.registerComponent('urban-environment', {
      init() {
        // Buildings pushed back to 15m to prevent collision
        this.createCityBlock(-60, -15, -60, -15); // NW
        this.createCityBlock( 15, 60, -60, -15);  // NE
        this.createCityBlock(-60, -15,  15, 60);  // SW
        this.createCityBlock( 15, 60,  15, 60);   // SE
      },

      createCityBlock(minX, maxX, minZ, maxZ) {
        const w = maxX - minX;
        const h = maxZ - minZ;
        const cx = (minX + maxX) / 2;
        const cz = (minZ + maxZ) / 2;
        
        // 1. Curb (Raised edge)
        const curb = document.createElement('a-box');
        curb.setAttribute('position', `${cx} 0.15 ${cz}`);
        curb.setAttribute('width', w); curb.setAttribute('depth', h); curb.setAttribute('height', 0.3);
        curb.setAttribute('color', '#7f8c8d'); // Concrete
        this.el.appendChild(curb);

        // 2. Pavement (Top surface)
        const pav = document.createElement('a-plane');
        pav.setAttribute('position', `${cx} 0.31 ${cz}`);
        pav.setAttribute('width', w - 0.4); pav.setAttribute('height', h - 0.4);
        pav.setAttribute('rotation', '-90 0 0');
        pav.setAttribute('color', '#95a5a6'); 
        this.el.appendChild(pav);

        // 3. Buildings & Trees
        for (let x = minX + 2; x < maxX - 2; x += 10) {
            for (let z = minZ + 2; z < maxZ - 2; z += 10) {
                if (Math.random() > 0.4) {
                    this.createBuilding(x + 4, z + 4);
                } else if (Math.random() > 0.5) {
                    this.createTree(x + 4, z + 4);
                }
            }
        }
        
        // 4. Streetlights (Corners)
        this.createLamp(maxX > 0 ? 14 : -14, maxZ > 0 ? 14 : -14);
      },

      createBuilding(x, z) {
        const h = 7 + Math.random() * 14;
        const b = document.createElement('a-entity');
        b.setAttribute('position', `${x} ${h/2 + 0.3} ${z}`);
        
        const wall = document.createElement('a-box');
        wall.setAttribute('width', 8); wall.setAttribute('depth', 8); wall.setAttribute('height', h);
        const col = ['#34495e', '#2c3e50', '#546e7a'][Math.floor(Math.random()*3)];
        wall.setAttribute('color', col);
        wall.setAttribute('shadow', 'cast:true; receive:true');
        b.appendChild(wall);

        // Lit Windows
        for(let wy = 1; wy < h - 1; wy += 2.5) {
            this.addWindow(b, 0, wy - h/2, 4.05); // Front
            this.addWindow(b, 4.05, wy - h/2, 0, 90); // Side
        }
        this.el.appendChild(b);
      },

      addWindow(parent, x, y, z, ry=0) {
        if(Math.random() > 0.7) return; // Not every window is lit
        const win = document.createElement('a-plane');
        win.setAttribute('width', 1.2); win.setAttribute('height', 1.5);
        win.setAttribute('color', '#ffeb3b'); // Lit color
        win.setAttribute('shader', 'flat');
        win.setAttribute('position', `${x} ${y} ${z}`);
        if(ry) win.setAttribute('rotation', `0 ${ry} 0`);
        parent.appendChild(win);
      },

      createTree(x, z) {
        const t = document.createElement('a-entity');
        t.setAttribute('position', `${x} 0.3 ${z}`);
        
        const trunk = document.createElement('a-cylinder');
        trunk.setAttribute('radius', 0.25); trunk.setAttribute('height', 2);
        trunk.setAttribute('position', '0 1 0'); trunk.setAttribute('color', '#5d4037');
        
        const leaves = document.createElement('a-dodecahedron');
        leaves.setAttribute('radius', 1.5); leaves.setAttribute('position', '0 2.8 0');
        leaves.setAttribute('color', '#27ae60');
        leaves.setAttribute('shadow', 'cast:true');
        
        t.appendChild(trunk); t.appendChild(leaves);
        this.el.appendChild(t);
      },

      createLamp(x, z) {
        const l = document.createElement('a-entity');
        l.setAttribute('position', `${x} 0.3 ${z}`);
        
        const pole = document.createElement('a-cylinder');
        pole.setAttribute('radius', 0.1); pole.setAttribute('height', 5);
        pole.setAttribute('position', '0 2.5 0'); pole.setAttribute('color', '#222');
        
        const bulb = document.createElement('a-sphere');
        bulb.setAttribute('radius', 0.3); bulb.setAttribute('position', '0 5 0');
        bulb.setAttribute('color', '#fff'); 
        bulb.setAttribute('material', 'emissive: #fff; emissiveIntensity: 1');
        
        l.appendChild(pole); l.appendChild(bulb);
        this.el.appendChild(l);
      }
    });

    AFRAME.registerComponent('stop-sign', {
       schema: { rot: {type:'number'} },
       init() {
         const pole = document.createElement('a-cylinder');
         pole.setAttribute('color','gray'); pole.setAttribute('radius',0.05); pole.setAttribute('height',2); pole.setAttribute('position','0 1 0');
         const sign = document.createElement('a-circle');
         sign.setAttribute('color','#c0392b'); sign.setAttribute('radius',0.4); sign.setAttribute('position','0 2 0.06'); sign.setAttribute('side','double');
         const text = document.createElement('a-text');
         text.setAttribute('value', 'STOP'); text.setAttribute('align', 'center'); 
         text.setAttribute('scale', '0.8 0.8 0.8'); text.setAttribute('position', '0 2 0.07');
         this.el.appendChild(pole); this.el.appendChild(sign); this.el.appendChild(text);
         this.el.object3D.rotation.y = this.data.rot * (Math.PI/180);
       }
    });
  </script>
</head>

<body style="margin:0; background-color: #1a2330;">
  <a-scene background="color: #2c3e50" traffic-arbiter traffic-generator shadow="type: pcfsoft">

    <a-sky material="shader: gradient; topColor: #1a2330; bottomColor: #d35400"></a-sky> 
    
    <a-entity position="-30 15 -30">
       <a-sphere radius="2" color="#f1c40f" material="shader:flat; fog:false"></a-sphere>
       <a-entity light="type: directional; color: #ff9f43; intensity: 0.9; castShadow:true"></a-entity>
    </a-entity>
    <a-entity light="type: ambient; color: #6c5ce7; intensity: 0.4"></a-entity>

    <a-plane rotation="-90 0 0" width="200" height="200" color="#2c3e50"></a-plane>
    <a-plane rotation="-90 0 0" position="0 0.02 0" width="8" height="150" color="#1a1a1a"></a-plane>
    <a-plane rotation="-90 0 0" position="0 0.03 0" width="150" height="8" color="#1a1a1a"></a-plane>
    
    <a-plane rotation="-90 0 0" position="0 0.04 -6.5" width="8" height="0.6" color="white"></a-plane>
    <a-plane rotation="-90 0 0" position="0 0.04  6.5" width="8" height="0.6" color="white"></a-plane>
    <a-plane rotation="-90 0 0" position="-6.5 0.04 0" width="0.6" height="8" color="white"></a-plane>
    <a-plane rotation="-90 0 0" position=" 6.5 0.04 0" width="0.6" height="8" color="white"></a-plane>

    <a-entity urban-environment></a-entity>
    <a-entity stop-sign="rot:0" position="-6.5 0 -6.5"></a-entity>
    <a-entity stop-sign="rot:-90" position="6.5 0 -6.5"></a-entity>
    <a-entity stop-sign="rot:180" position="6.5 0 6.5"></a-entity>
    <a-entity stop-sign="rot:90" position="-6.5 0 6.5"></a-entity>

    <a-entity id="rig" position="-14 1.7 14" rotation="0 -45 0" wasd-controls>
      <a-entity camera look-controls></a-entity>
    </a-entity>

  </a-scene>
</body>
</html>
