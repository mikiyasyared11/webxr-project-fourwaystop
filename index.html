<!DOCTYPE html>
<html>
<head>
  <title>Realistic 4-Way Stop with City</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script>
    // --- Traffic Manager System ---
    AFRAME.registerSystem('traffic-manager', {
      init: function () {
        this.queue = [];
        this.activeCars = [];
        this.state = 'idle';
        this.timer = 0;
        this.cycleTime = 3.0; // Time for one car/pair to cross
      },
      register: function (car) {
        this.queue.push(car);
      },
      unregister: function (car) {
        const index = this.queue.indexOf(car);
        if (index > -1) {
          this.queue.splice(index, 1);
        }
        const activeIndex = this.activeCars.indexOf(car);
        if (activeIndex > -1) {
          this.activeCars.splice(activeIndex, 1);
        }
      },
      tick: function (t, dt) {
        if (this.state === 'crossing') {
          this.timer += dt / 1000;
          if (this.timer >= this.cycleTime) {
            this.state = 'idle';
            this.activeCars = [];
            this.timer = 0;
          }
        }

        if (this.state === 'idle' && this.queue.length > 0) {
          let nextCar = this.queue[0];
          if (nextCar.components['car-controller'].state === 'waiting') {
            this.state = 'crossing';
            this.activeCars.push(nextCar);
            nextCar.components['car-controller'].go();
            this.queue.shift();

            // Check for opposite car for parallel crossing
            if (this.queue.length > 0) {
              let oppositeCar = this.queue[0];
              if (oppositeCar.components['car-controller'].state === 'waiting' &&
                  oppositeCar.components['car-controller'].data.axis === nextCar.components['car-controller'].data.axis &&
                  oppositeCar.components['car-controller'].data.dir !== nextCar.components['car-controller'].data.dir &&
                  nextCar.components['car-controller'].intention === 'straight' &&
                  oppositeCar.components['car-controller'].intention === 'straight') {
                this.activeCars.push(oppositeCar);
                oppositeCar.components['car-controller'].go();
                this.queue.shift();
              }
            }
          }
        }
      }
    });

    // --- Car Controller Component ---
    AFRAME.registerComponent('car-controller', {
      schema: {
        speed: {type: 'number', default: 5},
        axis: {type: 'string', default: 'z'}, // 'x' or 'z'
        dir: {type: 'number', default: 1} // 1 or -1
      },
      init: function () {
        this.state = 'driving'; // driving, waiting, crossing, turning
        this.stopLine = 6;
        this.laneOffset = 2.5;
        this.intentions = ['straight', 'right', 'left'];
        this.intention = this.intentions[Math.floor(Math.random() * this.intentions.length)];
        
        this.turnTime = 2.0;
        this.turnTimer = 0;

        // Car Appearance
        const body = document.createElement('a-box');
        body.setAttribute('color', ['#FF0000', '#0000FF', '#00FF00', '#FFFF00', '#FFA500'][Math.floor(Math.random() * 5)]);
        body.setAttribute('depth', 4);
        body.setAttribute('width', 2);
        body.setAttribute('height', 1);
        body.setAttribute('position', '0 0.5 0');
        this.el.appendChild(body);

        const cabin = document.createElement('a-box');
        cabin.setAttribute('color', '#AAAAAA');
        cabin.setAttribute('depth', 2);
        cabin.setAttribute('width', 1.8);
        cabin.setAttribute('height', 0.8);
        cabin.setAttribute('position', '0 1.4 0');
        this.el.appendChild(cabin);

        this.resetPosition();
      },
      resetPosition: function() {
        let x = 0, z = 0, ry = 0;
        if (this.data.axis === 'z') {
          x = this.data.dir === 1 ? -this.laneOffset : this.laneOffset;
          z = -this.data.dir * 50;
          ry = this.data.dir === 1 ? 0 : 180;
        } else {
          x = -this.data.dir * 50;
          z = this.data.dir === 1 ? this.laneOffset : -this.laneOffset;
          ry = this.data.dir === 1 ? 90 : -90;
        }
        this.el.setAttribute('position', {x: x, y: 0, z: z});
        this.el.setAttribute('rotation', {x: 0, y: ry, z: 0});
        this.state = 'driving';
      },
      go: function() {
        if (this.intention === 'straight') {
          this.state = 'crossing';
        } else {
          this.startTurn();
        }
      },
      startTurn: function() {
        this.state = 'turning';
        this.turnTimer = 0;
        this.p0 = this.el.object3D.position.clone();

        let turnEnd = 6;
        let laneOffset = this.laneOffset;

        if (this.intention === 'right') {
          if (this.data.axis === 'z') {
            this.p2 = new THREE.Vector3(this.data.dir === -1 ? -turnEnd : turnEnd, 0, this.data.dir === -1 ? laneOffset : -laneOffset);
            this.p1 = new THREE.Vector3(this.p0.x, 0, this.p2.z);
            this.newData = { axis: 'x', dir: this.data.dir === -1 ? -1 : 1 };
          } else {
            this.p2 = new THREE.Vector3(this.data.dir === 1 ? -laneOffset : laneOffset, 0, this.data.dir === 1 ? -turnEnd : turnEnd);
            this.p1 = new THREE.Vector3(this.p2.x, 0, this.p0.z);
            this.newData = { axis: 'z', dir: this.data.dir === 1 ? -1 : 1 };
          }
        } else { // left
          if (this.data.axis === 'z') {
            this.p2 = new THREE.Vector3(this.data.dir === -1 ? turnEnd : -turnEnd, 0, this.data.dir === -1 ? laneOffset : -laneOffset);
            this.p1 = new THREE.Vector3(this.p2.x, 0, this.p0.z);
            this.newData = { axis: 'x', dir: this.data.dir === -1 ? 1 : -1 };
          } else {
            this.p2 = new THREE.Vector3(this.data.dir === 1 ? -laneOffset : laneOffset, 0, this.data.dir === 1 ? turnEnd : -turnEnd);
            this.p1 = new THREE.Vector3(this.p0.x, 0, this.p2.z);
            this.newData = { axis: 'z', dir: this.data.dir === 1 ? 1 : -1 };
          }
        }
      },
      tick: function (t, dt) {
        const pos = this.el.getAttribute('position');

        if (this.state === 'turning') {
          this.turnTimer += dt / 1000;
          let t = this.turnTimer / this.turnTime;
          if (t >= 1) {
            this.state = 'driving';
            this.turnTimer = 0;
            this.el.object3D.position.copy(this.p2);
            let lookAt = this.p2.clone().add(this.p2.clone().sub(this.p1).normalize());
            this.el.object3D.lookAt(lookAt);
            this.data.axis = this.newData.axis;
            this.data.dir = this.newData.dir;
          } else {
            let newPos = new THREE.Vector3();
            newPos.addScaledVector(this.p0, (1 - t) * (1 - t));
            newPos.addScaledVector(this.p1, 2 * (1 - t) * t);
            newPos.addScaledVector(this.p2, t * t);
            this.el.object3D.position.copy(newPos);

            let tangent = new THREE.Vector3();
            tangent.addScaledVector(this.p1.clone().sub(this.p0), 2 * (1 - t));
            tangent.addScaledVector(this.p2.clone().sub(this.p1), 2 * t);
            tangent.normalize();
            let lookAt = newPos.clone().add(tangent);
            this.el.object3D.lookAt(lookAt);
          }
          return;
        }

        if (this.state === 'driving' || this.state === 'crossing') {
          if (this.data.axis === 'z') {
            pos.z += this.data.speed * this.data.dir * dt / 1000;
          } else {
            pos.x += this.data.speed * this.data.dir * dt / 1000;
          }
          this.el.setAttribute('position', pos);
        }

        if (this.state === 'driving') {
          let dist = this.data.axis === 'z' ? pos.z * -this.data.dir : pos.x * -this.data.dir;
          if (dist > this.stopLine - 0.5 && dist < this.stopLine + 0.5) {
            this.state = 'waiting';
            this.el.system.register(this.el);
          }
        }

        if (Math.abs(pos.x) > 55 || Math.abs(pos.z) > 55) {
          this.resetPosition();
          this.intention = this.intentions[Math.floor(Math.random() * this.intentions.length)];
          if (this.state === 'waiting') {
             this.el.system.unregister(this.el);
          }
        }
      }
    });

    // --- Detailed City Component ---
    AFRAME.registerComponent('detailed-city', {
      init: function() {
        const scene = this.el.sceneEl;

        // Grass
        const grass = document.createElement('a-plane');
        grass.setAttribute('color', '#339933');
        grass.setAttribute('rotation', '-90 0 0');
        grass.setAttribute('width', '100');
        grass.setAttribute('height', '100');
        grass.setAttribute('position', '0 -0.01 0');
        scene.appendChild(grass);

        // Stop Signs
        this.createStopSign(-6, 0, -6, 0);
        this.createStopSign(6, 0, 6, 180);
        this.createStopSign(-6, 0, 6, 90);
        this.createStopSign(6, 0, -6, -90);

        // Buildings
        this.createBuilding(-25, 15, -25, 20, 30, '#AABBAA');
        this.createBuilding(25, 20, -25, 25, 35, '#BBCCBB');
        this.createBuilding(-25, 18, 25, 22, 28, '#99AA99');
        this.createBuilding(25, 22, 25, 28, 32, '#AABBAA');
        this.createBuilding(-45, 12, 0, 15, 24, '#889988');
        this.createBuilding(45, 14, 0, 15, 28, '#99AA99');

        // Trees
        this.createTree(-12, 0, -12);
        this.createTree(12, 0, -12);
        this.createTree(-12, 0, 12);
        this.createTree(12, 0, 12);
        this.createTree(-20, 0, 0);
        this.createTree(20, 0, 0);

        // Streetlights
        this.createStreetlight(-7, 0, -7);
        this.createStreetlight(7, 0, 7);
      },

      createStopSign: function(x, y, z, rot) {
        const sign = document.createElement('a-entity');
        sign.setAttribute('position', `${x} ${y} ${z}`);
        sign.setAttribute('rotation', `0 ${rot} 0`);

        const pole = document.createElement('a-cylinder');
        pole.setAttribute('color', '#555555');
        pole.setAttribute('height', '2');
        pole.setAttribute('radius', '0.05');
        sign.appendChild(pole);

        const top = document.createElement('a-entity');
        top.setAttribute('position', '0 2 0');
        
        const octagon = document.createElement('a-cylinder');
        octagon.setAttribute('color', '#cc0000');
        octagon.setAttribute('height', '0.1');
        octagon.setAttribute('radius', '0.4');
        octagon.setAttribute('segments-radial', '8');
        octagon.setAttribute('rotation', '90 0 0');
        top.appendChild(octagon);

        const border = document.createElement('a-ring');
        border.setAttribute('color', 'white');
        border.setAttribute('radius-inner', '0.35');
        border.setAttribute('radius-outer', '0.4');
        border.setAttribute('rotation', '90 0 0');
        border.setAttribute('position', '0 0 0.051');
        top.appendChild(border);

        const text = document.createElement('a-text');
        text.setAttribute('value', 'STOP');
        text.setAttribute('align', 'center');
        text.setAttribute('color', 'white');
        text.setAttribute('scale', '0.8 0.8 0.8');
        text.setAttribute('position', '0 0 0.06');
        top.appendChild(text);

        sign.appendChild(top);
        this.el.sceneEl.appendChild(sign);
      },

      createBuilding: function(x, y, z, w, h, color) {
        const building = document.createElement('a-box');
        building.setAttribute('position', `${x} ${y + h/2} ${z}`);
        building.setAttribute('width', w);
        building.setAttribute('height', h);
        building.setAttribute('depth', w);
        building.setAttribute('color', color);
        this.el.sceneEl.appendChild(building);
      },

      createTree: function(x, y, z) {
        const tree = document.createElement('a-entity');
        tree.setAttribute('position', `${x} ${y} ${z}`);

        const trunk = document.createElement('a-cylinder');
        trunk.setAttribute('color', '#8B4513');
        trunk.setAttribute('height', '1.5');
        trunk.setAttribute('radius', '0.2');
        trunk.setAttribute('position', '0 0.75 0');
        tree.appendChild(trunk);

        const leaves = document.createElement('a-sphere');
        leaves.setAttribute('color', '#228B22');
        leaves.setAttribute('radius', '1.5');
        leaves.setAttribute('position', '0 2.25 0');
        tree.appendChild(leaves);

        this.el.sceneEl.appendChild(tree);
      },
      
      createStreetlight: function(x, y, z) {
          const light = document.createElement('a-entity');
          light.setAttribute('position', `${x} ${y} ${z}`);
          
          const pole = document.createElement('a-cylinder');
          pole.setAttribute('color', '#444444');
          pole.setAttribute('height', '4');
          pole.setAttribute('radius', '0.1');
          pole.setAttribute('position', '0 2 0');
          light.appendChild(pole);
          
          const arm = document.createElement('a-box');
          arm.setAttribute('color', '#444444');
          arm.setAttribute('height', '0.1');
          arm.setAttribute('width', '1.5');
          arm.setAttribute('depth', '0.1');
          arm.setAttribute('position', '0.7 4 0');
          light.appendChild(arm);
          
          const bulb = document.createElement('a-sphere');
          bulb.setAttribute('color', '#FFFFEE');
          bulb.setAttribute('radius', '0.2');
          bulb.setAttribute('position', '1.4 3.8 0');
          bulb.setAttribute('material', 'emissive: #FFFFEE; emissiveIntensity: 0.5');
          light.appendChild(bulb);
          
          this.el.sceneEl.appendChild(light);
      }
    });
  </script>
</head>
<body>
  <a-scene traffic-manager>
    <a-entity detailed-city></a-entity>

    <a-plane position="0 0.01 0" rotation="-90 0 0" width="12" height="100" color="#333333"></a-plane>
    <a-plane position="0 0.01 0" rotation="-90 90 0" width="12" height="100" color="#333333"></a-plane>
    
    <a-entity position="0 0.02 0">
      <a-plane position="0 0 -25" rotation="-90 0 0" width="0.2" height="40" color="#FFFFFF"></a-plane>
      <a-plane position="0 0 25" rotation="-90 0 0" width="0.2" height="40" color="#FFFFFF"></a-plane>
      <a-plane position="-25 0 0" rotation="-90 90 0" width="0.2" height="40" color="#FFFFFF"></a-plane>
      <a-plane position="25 0 0" rotation="-90 90 0" width="0.2" height="40" color="#FFFFFF"></a-plane>
    </a-entity>

    <a-plane position="0 0.02 -6" rotation="-90 0 0" width="12" height="0.5" color="#FFFFFF"></a-plane>
    <a-plane position="0 0.02 6" rotation="-90 0 0" width="12" height="0.5" color="#FFFFFF"></a-plane>
    <a-plane position="-6 0.02 0" rotation="-90 90 0" width="12" height="0.5" color="#FFFFFF"></a-plane>
    <a-plane position="6 0.02 0" rotation="-90 90 0" width="12" height="0.5" color="#FFFFFF"></a-plane>

    <a-entity car-controller="axis: z; dir: 1"></a-entity>
    <a-entity car-controller="axis: z; dir: -1"></a-entity>
    <a-entity car-controller="axis: x; dir: 1"></a-entity>
    <a-entity car-controller="axis: x; dir: -1"></a-entity>

    <a-sky color="#FFD700"></a-sky> <a-light type="directional" color="#FFD700" intensity="0.8" position="-1 1 0"></a-light>
    <a-light type="ambient" color="#888888"></a-light>

    <a-camera position="0 15 30" rotation="-30 0 0"></a-camera>
  </a-scene>
</body>
</html>
